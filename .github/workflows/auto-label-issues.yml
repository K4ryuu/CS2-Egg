
on:
  issues:
    types: [opened]

jobs:
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Check sponsor status and add labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const issueAuthor = issue.user.login;
            const issueBody = issue.body || '';

            // Extract priority/urgency from issue body
            const priorityMatch = issueBody.match(/### Priority\s*\n\s*(.+)/i) ||
                                 issueBody.match(/### Urgency\s*\n\s*(.+)/i);

            let priorityLabel = null;
            if (priorityMatch) {
              const selection = priorityMatch[1].trim().toLowerCase();
              if (selection.includes('critical')) {
                priorityLabel = 'priority: critical';
              } else if (selection.includes('high')) {
                priorityLabel = 'priority: high';
              } else if (selection.includes('medium')) {
                priorityLabel = 'priority: medium';
              } else if (selection.includes('low')) {
                priorityLabel = 'priority: low';
              }
            }

            // Add priority label if found
            if (priorityLabel) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: [priorityLabel]
              });
            }

            try {
                const query = `
                  query($sponsor: String!) {
                    user(login: $sponsor) {
                      sponsorshipsAsMaintainer(first: 100) {
                        nodes {
                          sponsorEntity {
                            ... on User {
                              login
                            }
                            ... on Organization {
                              login
                            }
                          }
                          tier {
                            monthlyPriceInDollars
                          }
                        }
                      }
                    }
                  }
                `;

                const result = await github.graphql(query, {
                  sponsor: 'K4ryuu'
                });

                const sponsors = result.user.sponsorshipsAsMaintainer.nodes;
                const isSponsor = sponsors.some(s =>
                  s.sponsorEntity.login.toLowerCase() === issueAuthor.toLowerCase()
                );

                if (isSponsor) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: ['sponsor']
                  });

                  const sponsorship = sponsors.find(s =>
                    s.sponsorEntity.login.toLowerCase() === issueAuthor.toLowerCase()
                  );
                  const tier = sponsorship?.tier?.monthlyPriceInDollars || 0;

                  let thankYouMessage = `ğŸ’– **Thank you for being a GitHub Sponsor!**\n\n`;
                  thankYouMessage += `Hi @${issueAuthor}, thank you so much for your support! `;

                  if (tier >= 15) {
                    thankYouMessage += `As a **$${tier}/month sponsor**, your issue will receive **priority review and triage**.\n\n`;
                    thankYouMessage += `I'll get back to you as soon as possible. Your support helps keep this project alive and growing! ğŸš€`;
                  } else {
                    thankYouMessage += `Your support helps keep this project alive and growing! ğŸš€\n\n`;
                    thankYouMessage += `*Although this tier doesn't include priority support, I greatly appreciate your contribution!* ğŸ™`;
                  }

                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: thankYouMessage
                  });
                }
              } catch (error) {
                // Silently fail - don't comment on errors
              }
name: Project Automation

on:
  issues:
    types: [opened, reopened, labeled, unlabeled]
  pull_request:
    types: [opened, reopened]

jobs:
  automate-project:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read

    steps:
      - name: Auto-label and add to project
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const isPR = !!context.payload.pull_request;
            const item = isPR ? context.payload.pull_request : context.payload.issue;
            const itemAuthor = item.user.login;
            const itemBody = item.body || '';
            const labels = (item.labels || []).map(l => l.name);
            const isNew = context.payload.action === 'opened';
            const isReopened = context.payload.action === 'reopened';

            // ===== STEP 1: Auto-label (only for new issues, skip for PRs) =====
            if (!isPR && isNew) {
              // Extract priority from issue body
              const priorityMatch = itemBody.match(/### Priority\s*\n\s*(.+)/i) ||
                                   itemBody.match(/### Urgency\s*\n\s*(.+)/i);

              let priorityLabel = null;
              if (priorityMatch) {
                const selection = priorityMatch[1].trim().toLowerCase();
                // Match priority at the START of the selection to avoid false matches like "not critical"
                if (selection.startsWith('critical')) {
                  priorityLabel = 'priority: critical';
                } else if (selection.startsWith('high')) {
                  priorityLabel = 'priority: high';
                } else if (selection.startsWith('medium')) {
                  priorityLabel = 'priority: medium';
                } else if (selection.startsWith('low')) {
                  priorityLabel = 'priority: low';
                }
              }

              // Add priority label if found
              if (priorityLabel) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: item.number,
                  labels: [priorityLabel]
                });
                labels.push(priorityLabel);
              }

              // Check sponsor status
              try {
                const query = `
                  query($sponsor: String!) {
                    user(login: $sponsor) {
                      sponsorshipsAsMaintainer(first: 100) {
                        nodes {
                          sponsorEntity {
                            ... on User {
                              login
                            }
                            ... on Organization {
                              login
                            }
                          }
                          tier {
                            monthlyPriceInDollars
                          }
                        }
                      }
                    }
                  }
                `;

                const result = await github.graphql(query, {
                  sponsor: 'K4ryuu'
                });

                const sponsors = result.user.sponsorshipsAsMaintainer.nodes;
                const isSponsor = sponsors.some(s =>
                  s.sponsorEntity.login.toLowerCase() === itemAuthor.toLowerCase()
                );

                if (isSponsor) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: item.number,
                    labels: ['sponsor']
                  });
                  labels.push('sponsor');

                  const sponsorship = sponsors.find(s =>
                    s.sponsorEntity.login.toLowerCase() === itemAuthor.toLowerCase()
                  );
                  const tier = sponsorship?.tier?.monthlyPriceInDollars || 0;

                  let thankYouMessage = `ðŸ’– **Thank you for being a GitHub Sponsor!**\n\n`;
                  thankYouMessage += `Hi @${itemAuthor}, thank you so much for your support! `;

                  if (tier >= 15) {
                    thankYouMessage += `As a **$${tier}/month sponsor**, your issue will receive **priority review and triage**.\n\n`;
                    thankYouMessage += `I'll get back to you as soon as possible. Your support helps keep this project alive and growing! ðŸš€`;
                  } else {
                    thankYouMessage += `Your support helps keep this project alive and growing! ðŸš€\n\n`;
                    thankYouMessage += `*Although this tier doesn't include priority support, I greatly appreciate your contribution!* ðŸ™`;
                  }

                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: item.number,
                    body: thankYouMessage
                  });
                }
              } catch (error) {
                // Silently fail - don't comment on errors
              }
            }

            // ===== STEP 2: Add to project and update fields =====
            const projectId = 'PVT_kwHOBjsGhc4BPD0C';

            // Get field IDs
            const projectFields = await github.graphql(`
              query {
                node(id: "${projectId}") {
                  ... on ProjectV2 {
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2Field {
                          id
                          name
                        }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `);

            const fields = projectFields.node.fields.nodes;
            const statusField = fields.find(f => f.name === 'Status');
            const typeField = fields.find(f => f.name === 'Type');
            const priorityField = fields.find(f => f.name === 'Priority');
            const sponsorField = fields.find(f => f.name === 'Sponsor');

            // Determine field values
            let typeValue = null;
            let priorityValue = null;
            let sponsorValue = null;
            let statusValue = statusField.options.find(o => o.name === 'Backlog')?.id;

            if (isPR) {
              // PR always gets Type = 'PR'
              typeValue = typeField.options.find(o => o.name === 'PR')?.id;
            } else {
              // Issue type mapping from labels
              if (labels.includes('bug')) {
                typeValue = typeField.options.find(o => o.name === 'Bug')?.id;
              } else if (labels.includes('feature')) {
                typeValue = typeField.options.find(o => o.name === 'Feature')?.id;
              } else if (labels.includes('enhancement')) {
                typeValue = typeField.options.find(o => o.name === 'Enhancement')?.id;
              } else if (labels.includes('documentation')) {
                typeValue = typeField.options.find(o => o.name === 'Documentation')?.id;
              } else if (labels.includes('question')) {
                typeValue = typeField.options.find(o => o.name === 'Question')?.id;
              }

              // Priority mapping (issues only)
              if (labels.includes('priority: critical')) {
                priorityValue = priorityField.options.find(o => o.name === 'Critical')?.id;
              } else if (labels.includes('priority: high')) {
                priorityValue = priorityField.options.find(o => o.name === 'High')?.id;
              } else if (labels.includes('priority: medium')) {
                priorityValue = priorityField.options.find(o => o.name === 'Medium')?.id;
              } else if (labels.includes('priority: low')) {
                priorityValue = priorityField.options.find(o => o.name === 'Low')?.id;
              }

              // Sponsor mapping (issues only)
              if (labels.includes('sponsor')) {
                sponsorValue = sponsorField.options.find(o => o.name === 'Yes')?.id;
              } else {
                sponsorValue = sponsorField.options.find(o => o.name === 'No')?.id;
              }
            }

            // Add item to project (idempotent - returns existing item if already there)
            const addResult = await github.graphql(`
              mutation {
                addProjectV2ItemById(input: {
                  projectId: "${projectId}"
                  contentId: "${item.node_id}"
                }) {
                  item {
                    id
                  }
                }
              }
            `);
            const itemId = addResult.addProjectV2ItemById.item.id;

            // Update fields
            const updates = [];

            if (statusValue && (isNew || isReopened)) {
              updates.push(github.graphql(`
                mutation {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: "${projectId}"
                    itemId: "${itemId}"
                    fieldId: "${statusField.id}"
                    value: {singleSelectOptionId: "${statusValue}"}
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `));
            }

            if (typeValue) {
              updates.push(github.graphql(`
                mutation {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: "${projectId}"
                    itemId: "${itemId}"
                    fieldId: "${typeField.id}"
                    value: {singleSelectOptionId: "${typeValue}"}
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `));
            }

            if (priorityValue) {
              updates.push(github.graphql(`
                mutation {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: "${projectId}"
                    itemId: "${itemId}"
                    fieldId: "${priorityField.id}"
                    value: {singleSelectOptionId: "${priorityValue}"}
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `));
            }

            if (sponsorValue) {
              updates.push(github.graphql(`
                mutation {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: "${projectId}"
                    itemId: "${itemId}"
                    fieldId: "${sponsorField.id}"
                    value: {singleSelectOptionId: "${sponsorValue}"}
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `));
            }

            await Promise.all(updates);

            console.log(`âœ… ${isPR ? 'PR' : 'Issue'} processed successfully!`);